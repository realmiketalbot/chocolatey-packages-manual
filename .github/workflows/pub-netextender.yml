name: Publish package (NetExtender)

on:
  workflow_dispatch: {}

concurrency:
  group: publish-netextender
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  publish:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pack
        shell: pwsh
        working-directory: netextender
        run: |
          $before = Get-Date
          choco pack
          Get-ChildItem -Filter "netextender*.nupkg" | Format-Table Name, LastWriteTime

          $pkg = Get-ChildItem -Filter "netextender*.nupkg" |
            Where-Object { $_.LastWriteTime -ge $before } |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1

          if (-not $pkg) { throw "No new netextender*.nupkg produced by choco pack." }

          "NUPKG_PATH=$($pkg.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Guard: ensure version not already published
        shell: pwsh
        working-directory: netextender
        run: |
          [xml]$nuspec = Get-Content .\netextender.nuspec
          $id      = $nuspec.package.metadata.id
          $version = $nuspec.package.metadata.version

          Write-Host "Checking Chocolatey for $id $version"
          $info = choco info $id --version $version --source https://community.chocolatey.org/api/v2/ --limit-output

          # If Chocolatey finds it, choco info returns output containing the id/version.
          if ($LASTEXITCODE -eq 0 -and $info -match [regex]::Escape($id) -and $info -match [regex]::Escape($version)) {
            throw "Refusing to publish: $id $version already exists on Chocolatey."
          }

          Write-Host "OK: $id $version not found on Chocolatey; proceeding."

      - name: Push
        shell: pwsh
        working-directory: netextender
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          if (-not $env:CHOCO_API_KEY) { throw "CHOCO_API_KEY secret is not set." }
          if (-not $env:NUPKG_PATH) { throw "NUPKG_PATH was not set by Pack step." }

          choco push $env:NUPKG_PATH `
            --source "https://push.chocolatey.org/" `
            --api-key $env:CHOCO_API_KEY `
            --no-progress
