name: Publish NetExtender to Chocolatey

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
    paths:
      - "netextender/**"

permissions:
  contents: read

jobs:
  publish:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pack
        shell: pwsh
        working-directory: netextender
        run: |
          $before = Get-Date
          choco pack
          Get-ChildItem -Filter "netextender*.nupkg" | Format-Table Name, LastWriteTime

          $pkg = Get-ChildItem -Filter "netextender*.nupkg" |
            Where-Object { $_.LastWriteTime -ge $before } |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1

          if (-not $pkg) { throw "No new netextender*.nupkg produced by choco pack." }

          "NUPKG_PATH=$($pkg.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Push
        shell: pwsh
        working-directory: netextender
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          if (-not $env:CHOCO_API_KEY) { throw "CHOCO_API_KEY secret is not set." }
          if (-not $env:NUPKG_PATH) { throw "NUPKG_PATH was not set by Pack step." }

          choco push $env:NUPKG_PATH `
            --source "https://push.chocolatey.org/" `
            --api-key $env:CHOCO_API_KEY `
            --no-progress
