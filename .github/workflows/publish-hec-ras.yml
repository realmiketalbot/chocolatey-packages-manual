name: Publish package (HEC-RAS)

on:
  workflow_dispatch: {}
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - "hec-ras/**"

concurrency:
  group: publish-hec-ras
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  publish:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.merged == true &&
       github.event.pull_request.head.ref == 'au/hec-ras')

    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pack
        shell: pwsh
        working-directory: hec-ras
        run: |
          $before = Get-Date
          choco pack
          Get-ChildItem -Filter "hec-ras*.nupkg" | Format-Table Name, LastWriteTime

          $pkg = Get-ChildItem -Filter "hec-ras*.nupkg" |
            Where-Object { $_.LastWriteTime -ge $before } |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1

          if (-not $pkg) { throw "No new hec-ras*.nupkg produced by choco pack." }

          "NUPKG_PATH=$($pkg.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Guard
        shell: pwsh
        working-directory: hec-ras
        run: |
          [xml]$nuspec = Get-Content .\hec-ras.nuspec
          $id      = $nuspec.package.metadata.id
          $version = $nuspec.package.metadata.version

          Write-Host "Checking Chocolatey for $id $version"
          $info = choco info $id --version $version --source "https://community.chocolatey.org/api/v2/" --limit-output

          if ($LASTEXITCODE -ne 0) {
            throw "Could not query Chocolatey for $id $version (exit $LASTEXITCODE). Refusing to publish."
          }

          if ($info -match [regex]::Escape($id) -and $info -match [regex]::Escape($version)) {
            throw "Refusing to publish $id $version because it already exists on Chocolatey."
          }

          Write-Host "OK: $id $version not found on Chocolatey; proceeding."

      - name: Push
        shell: pwsh
        working-directory: hec-ras
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          if (-not $env:CHOCO_API_KEY) { throw "CHOCO_API_KEY secret is not set." }
          if (-not $env:NUPKG_PATH) { throw "NUPKG_PATH was not set by Pack step." }

          choco push $env:NUPKG_PATH `
            --source "https://push.chocolatey.org/" `
            --api-key $env:CHOCO_API_KEY `
            --no-progress
